# 协议规范

## 通信协议规范

### MQTT主题设计

> 设备上行 （设备 --> 服务端）  

**[vendor]/[device_type]/[device_sn]/[command]/server**

> 服务端下行 （服务端 --> 设备）

**[vendor]/[device_type]/[device_sn]/[command]/client**






#### 音频传输头部规范

**Topic： [vendor]/[device_type]/[device_sn]/voice/client**  
**Topic： [vendor]/[device_type]/[device_sn]/voice/server**

```c
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Ver  |    AudioType  |        SampleRate             | Ch| F |
|  (4)  |    (8)        |          (16)                 |(2)|(2)|    
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            FrameSeq           |           Timestamp           |
|             (16)              |              (16)             | 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         PayloadLen            |           CRC16 Checksum      |
|           (16)                |              (16)             |  
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ```
 说明：

| 位段范围   | 字段名          | 位宽  | 取值范围       | 说明（对标经典协议 + 音频场景）                                                                 |
|------------|-----------------|-------|----------------|--------------------------------------------------------------------------------------------------|
| 0-3        | Ver（版本号）   | 4bit  | 0~15           | 音频协议版本（0001=v1、0010=v2），参考IP协议版本字段，兼容后续升级                                |
| 4-11       | AudioType       | 8bit  | 0~255          | 音频编码类型：0x01=PCM、0x02=AAC、0x03=OPUS、0x04=MP3、0x05=G.711，参考RTP负载类型（PT）字段      |
| 12-27      | SampleRate      | 16bit | 0~65535 Hz     | 覆盖8k/16k/44.1k/48k等所有主流音频采样率                                                        |
| 28-29      | Ch（声道数）    | 2bit  | 01=单、10=双、11=多 | 精简位宽适配MQTT低带宽                                                                          |
| 30-31      | F（帧标志）     | 2bit  | 01=完整、10=分片、11=尾 | 参考TCP分段标志，支持分片传输                                                                    |
| 32-47      | FrameSeq        | 16bit | 0~65535        | 音频帧递增序号，参考TCP序列号，用于丢包检测、顺序重组                                            |
| 48-63      | Timestamp       | 16bit | 0~65535 ms     | 相对时间戳（基于首帧偏移），参考RTP时间戳，用于音频同步                                        |
| 64-79      | PayloadLen      | 16bit | 0~65535 字节   | 参考UDP长度字段，覆盖99%音频场景（OPUS/G.711/AAC单帧均≤64KB），超大帧可分片                        |
| 80-95      | CRC16 Checksum  | 16bit | 0~65535        | 参考TCP校验和字段，校验范围：头部（Ver~PayloadLen）+ 音频载荷数据，检测传输过程中的数据篡改/比特错误 |