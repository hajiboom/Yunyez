# 协议规范

## 通信协议规范

### MQTT主题设计

> 设备上行 （设备 --> 服务端）  

**[vendor]/[device_type]/[device_sn]/[command]/server**

> 服务端下行 （服务端 --> 设备）

**[vendor]/[device_type]/[device_sn]/[command]/client**



#### 音频传输头部规范

**Upload Topic： [vendor]/[device_type]/[device_sn]/voice/client**  
**Publish Topic： [vendor]/[device_type]/[device_sn]/voice/server**

```c
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Ver  |    AudioFormat|        SampleRate             | Ch| F |
|  (4)  |    (8)        |          (16)                 |(2)|(2)|    
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            FrameSeq           |           Timestamp           |
|             (16)              |              (16)             | 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         PayloadLen            |           CRC16 Checksum      |
|           (16)                |              (16)             |  
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ```
 说明：

| 位段范围   | 字段名          | 位宽  | 取值范围       | 说明（对标经典协议 + 音频场景）                                                                 |
|------------|-----------------|-------|----------------|--------------------------------------------------------------------------------------------------|
| 0-3        | Ver（版本号）   | 4bit  | 0~15           | 音频协议版本（0001=v1、0010=v2），参考IP协议版本字段，兼容后续升级                                |
| 4-11       | AudioFormat     | 8bit  | 0~255          | 音频编码格式：0x01=PCM、0x02=AAC、0x03=OPUS、0x04=MP3、0x05=G.711，参考RTP负载类型（PT）字段      |
| 12-27      | SampleRate      | 16bit | 0~65535 Hz     | 覆盖8k/16k/44.1k/48k等所有主流音频采样率                                                        |
| 28-29      | Ch（声道数）    | 2bit  | 01=单、10=双、11=多 | 精简位宽适配MQTT低带宽                                                                          |
| 30-31      | F（帧标志）     | 2bit  | 01=完整、10=分片、11=尾 | 参考TCP分段标志，支持分片传输                                                                    |
| 32-47      | FrameSeq        | 16bit | 0~65535        | 音频帧递增序号，参考TCP序列号，用于丢包检测、顺序重组                                            |
| 48-63      | Timestamp       | 16bit | 0~65535 ms     | 相对时间戳（基于首帧偏移），参考RTP时间戳，用于音频同步                                        |
| 64-79      | PayloadLen      | 16bit | 0~65535 字节   | 参考UDP长度字段，覆盖99%音频场景（OPUS/G.711/AAC单帧均≤64KB），超大帧可分片                        |
| 80-95      | CRC16 Checksum  | 16bit | 0~65535        | 参考TCP校验和字段，校验范围：头部（Ver~PayloadLen）+ 音频载荷数据，检测传输过程中的数据篡改/比特错误 |


### 无线图传协议规范
对于设备图像传输，不使用MQTT协议，而是使用自定义的UDP协议。（原因：MQTT协议在传输图像等大尺寸数据时，会存在较大的延迟和丢包问题， 且MQTT协议的设计初衷是为了低功耗设备的通信，而图像传输对延迟要求较高，MQTT是TCP协议）

> v1


### RTSP协议与H.264/H.265视频编码规范

#### RTSP协议规范

RTSP（Real Time Streaming Protocol，实时流传输协议）是一种网络控制协议，专为控制流媒体服务器而设计。它允许客户端远程控制流媒体服务器，如播放、暂停、快进和倒退等操作，并支持流媒体的实时传输。

**RTSP主要命令：**

- **DESCRIBE**：获取媒体描述信息（SDP格式）
- **SETUP**：建立传输通道，配置媒体传输参数
- **PLAY**：开始接收媒体流
- **PAUSE**：暂停流
- **TEARDOWN**：关闭会话并释放资源
- **OPTIONS**：查询服务器支持的方法
- **ANNOUNCE**：将描述信息发送给服务器

**RTSP请求格式：**
```
Method URI RTSP-Version
CSeq: sequence-number
Header1: value1
Header2: value2
...
[Message Body]
```

**RTSP响应格式：**
```
RTSP-Version Status-Code Reason-Phrase
CSeq: sequence-number
Header1: value1
Header2: value2
...
[Message Body]
```

#### H.264/H.265视频编码规范

H.264（AVC）和H.265（HEVC）是两种主流的视频编码标准，用于高效压缩视频数据。

**H.264关键技术特点：**
- 高压缩比：相比之前的编码标准，H.264具有更高的压缩效率
- 灵活性：支持不同分辨率和帧率的视频编码
- 广泛应用：从传统广播视频到现代流媒体服务
- 兼容性好：拥有庞大的硬件和软件支持

**H.265关键技术特点：**
- 更高压缩效率：相比H.264，可在相同视频质量下减少约50%的比特率
- 支持超高清：特别适合4K和8K超高清视频内容的传输和存储
- 更高色深支持：支持10位色深的视频内容，提供更丰富的色彩表现
- 算法优化：引入更灵活的预测单元划分、多参考帧预测、高精度运动估计等功能

#### RTP传输头部规范

由于RTSP协议通常与RTP协议配合使用来传输视频数据，以下是RTP包头格式：

```c
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|V=2|P|X|  CC   |M|     PT      |       sequence number         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           timestamp                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             SSRC                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ```

 说明：

| 位段范围   | 字段名              | 位宽  | 取值范围       | 说明（对标经典协议 + 视频场景）                                                                 |
|------------|---------------------|-------|----------------|--------------------------------------------------------------------------------------------------|
| 0-1        | V（版本号）         | 2bit  | 固定为2        | RTP协议版本号，参考RFC 3550标准                                                                  |
| 2          | P（填充标志）       | 1bit  | 0/1            | 指示RTP包是否包含额外填充字节，参考RFC 3550标准                                                  |
| 3          | X（扩展标志）       | 1bit  | 0/1            | 指示RTP头部后是否存在扩展头部，参考RFC 3550标准                                                |
| 4-7        | CC（CSRC计数）      | 4bit  | 0~15           | 标识CSRC标识符的数量，参考RFC 3550标准                                                           |
| 8          | M（标记位）         | 1bit  | 0/1            | 在特定负载类型中有特殊含义，参考RFC 3550标准                                                     |
| 9-15       | PT（负载类型）      | 7bit  | 0~127          | 指示RTP负载的格式，H.264通常为96-127动态分配值，参考RFC 3550标准                               |
| 16-31      | sequence number     | 16bit | 0~65535        | 序列号递增，参考TCP序列号，用于丢包检测、顺序重组                                                |
| 32-63      | timestamp           | 32bit | 0~2^32-1       | 时间戳，H.264/265时钟频率为90kHz，用于同步和抖动计算                                             |
| 64-95      | SSRC                | 32bit | 0~2^32-1       | 同步源标识符，区分不同的数据源，参考RFC 3550标准                                                 |


#### H.264/H.265 NALU单元头部规范

H.264/H.265视频流的基本单元是NALU（Network Abstraction Layer Unit），其头部格式如下：

**H.264 NALU头部格式：**
```c
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|F|NRI|  Type   |                                               |
+-+-+-+-+-+-+-+-+                                               |
|                                                               |
|                    H.264 NALU Payload                         |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ```

**H.264 NALU头部说明：**

| 位段范围   | 字段名              | 位宽  | 取值范围       | 说明（对标经典协议 + 视频场景）                                                                 |
|------------|---------------------|-------|----------------|--------------------------------------------------------------------------------------------------|
| 0          | F（禁止位）         | 1bit  | 0              | 禁止位，一般为0，若为1则表示该NALU无效                                                            |
| 1-2        | NRI（重要性指示）   | 2bit  | 0~3            | 表示NALU的重要性，0表示非关键信息，3表示关键信息                                                 |
| 3-7        | Type（NALU类型）    | 5bit  | 1~31           | NALU类型：1-5为视频编码数据，6-12为辅助信息，7为SPS，8为PPS，28为FU-A分片单元                    |


**H.265 NALU头部格式：**
```c
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|F| Type    |  LayerId  | TID |                                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
|                                                               |
|                    H.265 NALU Payload                         |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ```

**H.265 NALU头部说明：**

| 位段范围   | 字段名              | 位宽  | 取值范围       | 说明（对标经典协议 + 视频场景）                                                                 |
|------------|---------------------|-------|----------------|--------------------------------------------------------------------------------------------------|
| 0          | F（禁止位）         | 1bit  | 0              | 禁止位，一般为0，若为1则表示该NALU无效                                                            |
| 1-5        | Type（NALU类型）    | 5bit  | 0~63           | NALU类型：0-31为VCL单元，32-63为非VCL单元                                                         |
| 6-10       | LayerId（层ID）     | 5bit  | 0~63           | 层ID，用于多层编码                                                                                |
| 11-15      | TID（时间ID+1）     | 4bit  | 1~15           | 时间ID加1，用于时间层索引                                                                         |


#### H.264/H.265分片传输规范（FU-A）

当NALU单元过大（超过MTU限制，通常1400字节）时，需要使用分片传输机制。以下是H.264的FU-A格式：

**H.264 FU-A RTP负载格式：**
```c
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| FU indicator|   FU header   |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
|                                                               |
|                    H.264 FU-A Payload                         |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ```

**FU indicator格式：**

| 位段范围   | 字段名              | 位宽  | 取值范围       | 说明（对标经典协议 + 视频场景）                                                                 |
|------------|---------------------|-------|----------------|--------------------------------------------------------------------------------------------------|
| 0          | F（错误标志）       | 1bit  | 0              | 错误标志，一般为0                                                                                 |
| 1-2        | NRI（重要性指示）   | 2bit  | 复制原NALU值   | 直接复制原NALU的NRI值                                                                             |
| 3-7        | Type（类型）        | 5bit  | 固定为28       | 指示这是FU-A格式，值为28                                                                          |

**FU header格式：**

| 位段范围   | 字段名              | 位宽  | 取值范围       | 说明（对标经典协议 + 视频场景）                                                                 |
|------------|---------------------|-------|----------------|--------------------------------------------------------------------------------------------------|
| 0          | S（开始标志）       | 1bit  | 0/1            | NALU分片的第一个包，此位设为1                                                                     |
| 1          | E（结束标志）       | 1bit  | 0/1            | NALU分片的最后一个包，此位设为1                                                                   |
| 2          | R（保留位）         | 1bit  | 0              | 保留位，必须为0                                                                                   |
| 3-7        | Type（类型）        | 5bit  | 复制原NALU值   | 复制原NALU的Type值                                                                                |
