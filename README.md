# 云也子(Yunyez)

![项目结构图](docs/architecture.png)

## 🌟 项目简介
云野迹(Yunyez) 是一个 **定制电子宠物**，核心目标是打通“智能设备-后端服务-数据可视化”全链路：
- 设备端（ESP32开发板/模拟器）：通过 MQTT 上报定位、照片等打卡数据，支持自动/语音打卡；
- 后端服务：基于 Go 开发，用 gRPC 优化服务间通信，HTTP 提供前端接口，支持配置化规则扩展；
- 数据存储：PostgreSQL 存核心结构化数据，MongoDB 存非结构化附件，Redis 做缓存；
- 前端看板：可视化展示电子宠物的状态、旅行陪伴打卡记录、设备配置，支持实时推送。

## 🛠️ 技术栈
### 核心技术
| 分类         | 技术选型                                                                 |
|--------------|--------------------------------------------------------------------------|
| 后端语言     | Go 1.24.8                                                                 |
| 通信协议     | gRPC（服务间）、HTTP/JSON（前后端）、MQTT 3.1.1（设备-后端）、WebSocket（实时推送） |
| 数据序列化   | Protocol Buffers（Proto3）、JSON                                          |
| 数据库       | PostgreSQL 16（结构化核心数据）、MongoDB 6（非结构化数据）、Redis 7（缓存） |
| 中间件       | EMQX（MQTT Broker）、Docker（容器化）、K8s（集群部署）、Minikube（本地测试） |
| Web框架      | Gin（HTTP接口）                                                          |
| ORM/客户端   | GORM（PostgreSQL）、mongo-driver（MongoDB）、go-redis（Redis）、paho.mqtt.golang（MQTT） |

### 工程工具
- 版本控制：Git
- 文档：DrawIO + feishu
- 调试工具：Postman（HTTP）、MQTTX（MQTT）、Goland Debug
- 部署工具：Docker Compose（本地一键启动）、K8s（集群部署）

## 🎯 核心功能
### 1. 设备打卡模块
- ✅ 设备通过 MQTT 上报打卡数据（定位、照片、设备ID），支持 Proto/JSON 双格式
- ✅ 配置化打卡规则（景点范围、设备权限），无需改代码新增景点/设备
- ✅ 打卡有效性校验（定位与景点距离≤100米）
- ✅ 批量打卡支持（gRPC 流式通信，适配设备批量上报）

### 2. 后端服务模块
- ✅ 服务拆分：设备服务（MQTT消息处理、设备管理）、打卡服务（打卡逻辑、统计）
- ✅ 双通信模式：gRPC（服务间高效通信）+ HTTP（前端/第三方调用）
- ✅ 实时推送：WebSocket 推送打卡通知、设备在线状态
- ✅ 数据分层：Repository 层封装数据库操作，Service 层处理业务逻辑

### 3. 数据存储模块
- ✅ 结构化数据（用户、景点、打卡核心信息）→ PostgreSQL（支持事务、关联查询）
- ✅ 非结构化数据（打卡照片、设备日志）→ MongoDB（高写入、灵活扩展）
- ✅ 热点数据（设备在线状态、打卡缓存）→ Redis（高性能读取）

### 4. 可视化看板模块
- ✅ 旅行足迹地图：展示用户打卡地点分布
- ✅ 数据统计：按时间/景点/用户维度统计打卡次数
- ✅ 设备状态监控：查看设备在线状态、最近打卡记录
- ✅ 实时通知：打卡成功后前端实时收到提醒

### 5. 部署与运维
- ✅ Docker 容器化：所有服务+中间件支持 Docker 打包
- ✅ K8s 集群部署：支持服务扩容、配置管理、服务发现
- ✅ 日志记录：Zap 日志框架，按服务分类输出，便于问题排查

## 🏗️ 项目架构
### 整体架构图


### 核心数据流


## 使用场景
### 1、🌍 旅行搭子：基于多模态感知的三维情感记忆系统
> 💡 问题定义 

现有旅行记录工具（如手机相册、打卡 App）依赖用户主动操作，导致：  
- 记忆碎片化（仅保存“高光时刻”）
- 缺乏空间上下文（仅有 GPS 坐标，无环境结构）
- 检索效率低（无法按“氛围”“情绪”“场景”召回）  
> 🔬 技术方案  

我们构建一个 端-边-云协同的轻量化三维记忆系统，实现无感、连续、可回溯的旅行记录。  

1. 设备端（边缘感知层）  
- **多源定位融合**：GPS/北斗 + Wi-Fi/蓝牙指纹 + IMU，实现室内外无缝定位（精度：市区 5–10m，景区 10–20m）  
- **轻量级视觉 SLAM（可选）**：  
若设备带摄像头：运行稀疏 ORB-SLAM3 子模块，提取关键帧与点云  
若无摄像头：通过蓝牙连接用户手机，复用其 ARKit/ARCore 构建的局部 3D 场景
- **语音交互引擎**：本地部署小型 ASR + NLU 模型（如 Whisper-tiny + Rasa），支持离线关键词唤醒（“记一下这里”）
- **低功耗设计**：采用事件驱动架构，仅在移动/语音触发时激活传感器
2. 云端（记忆中枢）
- **时空图数据库**：使用 Nebula Graph 或自研索引，将以下实体关联：
User → Trip → [Location, Timestamp, EmotionTag, Media, PointCloud]
- **3D 轨迹重建**：融合 GPS 轨迹 + 视觉关键帧，生成可漫游的轻量化 3D 路径（格式：glTF + GeoJSON）
- **隐私保护**：所有媒体数据客户端加密（AES-256），密钥由用户持有；元数据脱敏后用于 AI 训练
3. 平台端（交互层）
- **WebGL 3D 地图引擎**：  
基于 CesiumJS 或 Mapbox GL JS 扩展，支持：
点击轨迹节点 → 播放当时录音 + 展示 360° 环境快照
时间滑块拖拽 → 动态回放当日移动路径
- **AI 记忆助手**：  
基于 LLM（如 Qwen / Llama 3）生成结构化日志：“5月12日，你在京都哲学之道漫步，听到流水声，拍下樱花，说‘真想住在这里’”  
支持自然语言查询：“展示所有下雨天的咖啡馆记忆”

> 🎯 聚焦  

✅ 无感三维记录：无需用户举手机，即可捕获空间语义  
✅ 跨模态对齐：语音、图像、位置、时间自动关联  
✅ 边缘-云协同：保障体验的同时控制成本与隐私  
本系统目前阶段不追求高精度建图（如厘米级），而是聚焦 “情感可回溯性” —— 让用户能回到那个氛围里，而非仅仅看到坐标。
